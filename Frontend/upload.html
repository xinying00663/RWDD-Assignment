<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share a Recycling Program</title>
    <link rel="stylesheet" href="styles/general.css">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/uploadPage.css">
</head>
<body data-page="upload">
    <!-- Sidebar will be loaded here by sidebar.js -->
    <main>
        <section class="tabs-card upload-card">
            <div class="section-header">
                <h2>Share a recycling program</h2>
                <p>List your next drop-off drive, clean-up sprint, or repair workshop so neighbours can pitch in.</p>
            </div>
            <form class="upload-form" action="php/uploadPost.php" method="POST">
                <div class="upload-form__grid">
                    <div class="input-group">
                        <label for="eventName">Program name</label>
                        <input type="text" id="eventName" name="eventName" placeholder="e.g. Weekend Plastic Swap" required>
                    </div>
                    <div class="input-group">
                        <label for="eventLocation">Location</label>
                        <!-- Search box for places + map picker. Users can search or click the map to pick a location. -->
                        <input type="text" id="eventLocationSearch" name="eventLocationSearch" placeholder="Type an address" autocomplete="off">
                        <div id="map" style="width:100%;height:320px;border:1px solid #ddd;margin-top:8px;border-radius:6px"></div>
                        <p class="helper-text">Click the map to set the program location or search above. Drag the marker to adjust.</p>
                    </div>
                    <div class="input-group">
                        <label for="eventDate">Event date From</label>
                        <input type="date" id="eventDate" name="eventDate" required>
                    </div>
                    <div class="input-group">
                        <label for="eventDateTo">Event date To</label>
                        <input type="date" id="eventDateTo" name="eventDateTo" required>
                    </div>
                    <div class="input-group input-group--full">
                        <label for="eventDescription">Program details</label>
                        <textarea id="eventDescription" name="eventDescription" rows="5" placeholder="Share the schedule, needed supplies, or special instructions." required></textarea>
                    </div>
                </div>
                <!-- Coordinator contact fields so neighbours know who will follow up -->
                <div class="upload-form__section">
                    <h3>Program coordinator</h3>
                    <p class="helper-text">These details appear on the program page so volunteers can reach you directly.</p>
                    <div class="upload-form__grid">
                        <div class="input-group">
                            <label for="coordinatorName">Coordinator name</label>
                            <input type="text" id="coordinatorName" name="coordinatorName" placeholder="e.g. Amina Rahman">
                        </div>
                        <div class="input-group">
                            <label for="coordinatorEmail">Coordinator email</label>
                            <input type="email" id="coordinatorEmail" name="coordinatorEmail" placeholder="organiser@example.com">
                        </div>
                        <div class="input-group">
                            <label for="coordinatorPhone">Coordinator phone</label>
                            <input type="tel" id="coordinatorPhone" name="coordinatorPhone" placeholder="e.g. +60 12-345 6789">
                        </div>
                    </div>
                </div>
                <!-- Dynamic sections let organisers add custom panels like weekly plans or equipment lists -->
                <div class="upload-form__section">
                    <div class="section-header">
                        <h3>Program sections</h3>
                        <p>Add as many sections as you need &mdash; weekly plans, preparation tips, or anything else.</p>
                    </div>
                    <div class="dynamic-sections" data-section-list></div>
                    <button type="button" class="button-secondary" data-section-add>Add section</button>
                    <template id="program-section-template">
                        <div class="dynamic-section" data-section>
                            <div class="input-group input-group--full">
                                <label>Section title</label>
                                <input type="text" name="sectionTitle[]" placeholder="e.g. Weekly plan">
                            </div>
                            <div class="input-group input-group--full">
                                <label>Section details</label>
                                <textarea name="sectionDescription[]" rows="4" placeholder="Describe the timing, key activities, or important notes."></textarea>
                            </div>
                            <button type="button" class="button-remove" data-section-remove>Remove section</button>
                        </div>
                    </template>
                </div>
                <div class="upload-form__footer">
                    <p class="helper-text">We'll surface your submission on the community feed once approved.</p>
                    <div class="upload-form__actions">
                        <button type="button" class="button-cancel" onclick="window.location.href='homePage.html'">Cancel</button>
                        <button type="submit">Submit program</button>
                    </div>
                </div>
                
            </form>
        </section>
    </main>
    <script src="script/sidebar.js?v=2"></script>
    <script>
        // Map picker logic
        let map, marker, autocompleteService, placesService, geocoder;
        function initMapPicker() {
            const searchInput = document.getElementById('eventLocationSearch');
            const latInput = document.getElementById('eventLat');
            const lngInput = document.getElementById('eventLng');

            // default center (fallback to a sensible lat/lng)
            const defaultPos = { lat: 3.1390, lng: 101.6869 }; // Kuala Lumpur as example

            // create map container if not already
            try {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: defaultPos,
                    zoom: 13,
                });

                marker = new google.maps.Marker({
                    position: defaultPos,
                    map: map,
                    draggable: true,
                });

                geocoder = new google.maps.Geocoder();

                // when marker dragged, update hidden inputs
                marker.addListener('dragend', function() {
                    const pos = marker.getPosition();
                    latInput.value = pos.lat();
                    lngInput.value = pos.lng();
                });

                // click map to move marker
                map.addListener('click', function(ev) {
                    marker.setPosition(ev.latLng);
                    latInput.value = ev.latLng.lat();
                    lngInput.value = ev.latLng.lng();
                });

                // try to wire up Places search if available
                try {
                    const input = searchInput;
                    const options = { fields: ['geometry', 'name', 'formatted_address'] };
                    // Use Place AutocompleteElement if available (newer) or fallback to Autocomplete
                    if (google.maps.places && google.maps.places.PlaceAutocompleteElement) {
                        // Newer PlaceAutocompleteElement path (if present) - graceful fallback below will handle classic Autocomplete
                        const pae = new google.maps.places.PlaceAutocompleteElement({ element: input, options: { types: ['address', 'establishment'] } });
                        pae.addListener('change', async (e) => {
                            // PlaceAutocompleteElement provides place on change; try geocode by text as fallback
                            const text = input.value;
                            geocodeText(text);
                        });
                    } else if (google.maps.places && google.maps.places.Autocomplete) {
                        const ac = new google.maps.places.Autocomplete(input, { types: ['geocode', 'establishment'] });
                        ac.bindTo('bounds', map);
                        ac.addListener('place_changed', function() {
                            const place = ac.getPlace();
                            if (place && place.geometry && place.geometry.location) {
                                map.panTo(place.geometry.location);
                                map.setZoom(15);
                                marker.setPosition(place.geometry.location);
                                latInput.value = place.geometry.location.lat();
                                lngInput.value = place.geometry.location.lng();
                            } else {
                                // fallback: geocode the typed text
                                geocodeText(input.value);
                            }
                        });
                    } else {
                        // Places not available; we'll use text search on blur
                        searchInput.addEventListener('blur', () => geocodeText(searchInput.value));
                    }
                } catch (e) {
                    // if anything fails, fallback later
                    console.warn('Places setup failed', e);
                    searchInput.addEventListener('blur', () => geocodeText(searchInput.value));
                }

                // helper: geocode typed text using Google if available, otherwise Nominatim
                function geocodeText(text) {
                    if (!text || text.trim() === '') return;
                    if (geocoder) {
                        geocoder.geocode({ address: text }, function(results, status) {
                            if (status === 'OK' && results[0]) {
                                const loc = results[0].geometry.location;
                                map.panTo(loc);
                                map.setZoom(15);
                                marker.setPosition(loc);
                                latInput.value = loc.lat();
                                lngInput.value = loc.lng();
                                return;
                            } else {
                                // fallback to Nominatim
                                geocodeNominatim(text).then(r => {
                                    if (r) {
                                        const pos = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
                                        map.panTo(pos);
                                        map.setZoom(15);
                                        marker.setPosition(pos);
                                        latInput.value = pos.lat;
                                        lngInput.value = pos.lng;
                                    }
                                });
                            }
                        });
                    } else {
                        geocodeNominatim(text).then(r => {
                            if (r) {
                                const pos = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
                                map.panTo(pos);
                                map.setZoom(15);
                                marker.setPosition(pos);
                                latInput.value = pos.lat;
                                lngInput.value = pos.lng;
                            }
                        });
                    }
                }

            } catch (err) {
                console.error('Google Maps failed; map picker not available', err);
                // fallback: show a basic static map area with a message and still allow geocoding on blur
                const mapEl = document.getElementById('map');
                mapEl.innerHTML = '<div style="padding:18px;color:#666">Map unavailable. Type an address into the search box and move focus away to resolve the location.</div>';
                document.getElementById('eventLocationSearch').addEventListener('blur', () => geocodeNominatim(document.getElementById('eventLocationSearch').value));
            }
        }

        // Nominatim fallback geocode
        async function geocodeNominatim(address) {
            if (!address || address.trim() === '') return null;
            const url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&q=' + encodeURIComponent(address);
            try {
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return null;
                const data = await res.json();
                if (Array.isArray(data) && data.length > 0) return data[0];
            } catch (e) { console.warn('Nominatim error', e); }
            return null;
        }

        // If the Google Maps script is loaded with a callback, call initMapPicker then. Otherwise try to wait for window.google
        function ensureInit() {
            if (window.google && google.maps) {
                initMapPicker();
            } else {
                // wait a bit and try again (in case Maps script is still loading)
                let tries = 0;
                const id = setInterval(() => {
                    if (window.google && google.maps) {
                        clearInterval(id);
                        initMapPicker();
                    }
                    tries++;
                    if (tries > 40) { clearInterval(id); /* give up after ~4s */ }
                }, 100);
            }
        }

        // Start when DOM ready
        document.addEventListener('DOMContentLoaded', ensureInit);
        </script>

        <!-- Load Google Maps JavaScript API (replace YOUR_API_KEY) -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAX23VSgysvFGdvQRAadSkUkhIvF9-B6Mo&libraries=places&callback=initMap" async defer></script>
</body>
</html>




